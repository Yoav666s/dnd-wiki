{% capture tooltip_content %}
{% if include.title contains ':' %}
  {% assign collection = include.title | split: ":" | first %}
  {% assign title = include.title | split: ":" | last %}
{% else %}
  {% assign collection = page.permalink | split: "/" | slice: 1 | first %}
  {% assign title = include.title %}
{% endif %}
{% if title contains "#" %}
  {% assign tag = title | split: "#" | last %}
  {% assign title = title | split: "#" | first %}
{% endif %}
{% if title contains "@" %}
  {% assign index = title | split: "@" | last | slugify %}
  {% assign title = title | split: "@" | first %}
  {% unless tag %}
    {% assign tag = title %}
  {% endunless %}
{% else %}
  {% assign index = title | slugify %}
{% endif %}
{% if tag %}
  {% assign tag = tag | slugify | prepend: "#" %}
{% endif %}
{% assign spell = site.spells | where: "index", index | first %}
{% assign tooltip = site.tooltips | where: "index", index | first %}
{% assign subpage = site[collection] | where: "index", index | first %}
{% if spell %}
<span class="tooltip">
  <a href="{{ spell.permalink | append: tag }}" class="tooltip-link">
    {{ title }}
  </a>
  <span class="tooltip-content">
    <strong>{{ spell.level }}</strong> ({{ spell.school }})<br>
    <i>{{ spell.excerpt | markdownify | strip_html }}</i>
  </span>
</span>
{% elsif tooltip %}
<span class="tooltip">
  <a {% if tooltip.link %}href="{{ tooltip.link | append: tag }}" {% endif %}class="tooltip-link">
    {{ title }}
  </a>
  {% if tooltip.content %}
    <span class="tooltip-content">
      {{ tooltip.content }}
    </span>
  {% endif %}
</span>
{% elsif subpage %}
  <span class="tooltip">
    <a href="{{ subpage.permalink | relative_url | append: tag }}" class="tooltip-link">
      {{ title }}
    </a>
    <span class="tooltip-content"{% if tag %} style="width: {{ tag | size | times: 8 }}px;"{% endif %}>
      {% if tag %}
        <strong>{{ tag | replace: "-", " " | remove: "#" | capitalize }}</strong> ({{ subpage.title }})<br>
      {% else %}
        {{ subpage.excerpt | slice: 0, 100 }}{% if subpage.excerpt.size > 100 %}...{% endif %}
      {% endif %}
    </span>
  </span>
{% else %}
  <a href="#{{ index }}" >{{ title }}</a>
{% endif %}
{% endcapture %}{{ tooltip_content | strip_newlines | strip }}
