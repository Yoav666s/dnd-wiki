{% capture tooltip_content %}
{% assign tag = nil %}
{% if include.title contains ':' %}
  {% assign collection = include.title | split: ":" | first %}
  {% assign title = include.title | split: ":" | last %}
{% else %}
  {% assign collection = page.permalink | split: "/" | slice: 1 | first %}
  {% assign title = include.title %}
{% endif %}
{% if title contains "!" %}
  {% assign title = title | remove: "!" %}
  {% assign show_tooltip = false %}
{% else %}{% assign show_tooltip = true %}
{% endif %}
{% if title contains "#" %}
  {% assign tag = title | split: "#" | last %}
  {% assign title = title | split: "#" | first %}
{% endif %}
{% if title contains "@" %}
  {% assign index = title | split: "@" | last | slugify %}
  {% assign title = title | split: "@" | first %}
  {% unless tag %}
    {% assign tag = title %}
  {% endunless %}
{% else %}
  {% assign index = title | slugify %}
{% endif %}
{% if tag %}
  {% assign tag = tag | slugify | prepend: "#" %}
{% endif %}
{% assign spell = site.spells | where_exp: "item", "item.index contains index" | first %}
{% assign tooltip = site.tooltips | where_exp: "item", "item.index contains index" | first %}
{% assign subpage = site[collection] | where_exp: "item", "item.index contains index" | first %}
{% if spell %}
<span class="tooltip">
  <a href="{{ spell.permalink | append: tag }}" class="tooltip-link">
    {{ title }}
  </a>
  {% if show_tooltip %}
  <span class="tooltip-content">
    <strong>{{ spell.level }}</strong> ({{ spell.school }})<br>
    <i>{{ spell.excerpt | markdownify | strip_html }}</i>
  </span>
  {% endif %}
</span>
{% elsif tooltip %}
<span class="tooltip">
  <a {% if tooltip.link %}href="{{ tooltip.link | append: tag }}" {% endif %}class="tooltip-link">
    {{ title }}
  </a>
  {% if tooltip.content and show_tooltip %}
    <span class="tooltip-content">
      <strong>{{ tooltip.title }}</strong><br>
      <i>{{ tooltip.content }}</i>
    </span>
  {% endif %}
</span>
{% elsif subpage %}
  <span class="tooltip">
    <a href="{{ subpage.permalink | relative_url | append: tag }}" class="tooltip-link">
      {{ title }}
    </a>
    {% if show_tooltip %}
      {% if tag %}
        {% if title.size > tag.size %}{% assign max = title.size %}
        {% else%}{% assign max = tag.size %}{% endif %}
        {% unless max > 7 %}{% assign max = 8 %}{% endunless %}
      {% endif %}
      <span class="tooltip-content"{% if tag %} style="width: {{ max | times: 10.1 }}px; text-align: center; left: 50%; transform: translateX(-50%);"{% endif %}>
        {% if tag %}
          <strong>{{ tag | replace: "-", " " | remove: "#" | capitalize }}</strong><br>{{ subpage.title }}<br>
        {% else %}
          {{ subpage.excerpt | slice: 0, 100 | markdownify | strip_html | strip }}{% if subpage.excerpt.size > 150 %}...{% endif %}
        {% endif %}
      </span>
    {% endif %}
  </span>
{% else %}
  <a href="#{{ index }}" class="tooltip-link">{{ title }}</a>
{% endif %}
{% endcapture %}{{ tooltip_content | strip_newlines | strip }}
